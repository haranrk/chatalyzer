<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Chatalyzer Analysis</title>
        <link rel="stylesheet" href={{ url_for('static', filename='css/bootstrap.min.css') }} >
        <link rel="stylesheet" href={{ url_for('static', filename='css/main.css') }} >
    </head>
    <body>
        {% include 'navbar.html' %}
        <div class="container">
            <h1>Analysis of your chat</h1>
            <p>{{ num_msgs }}</p>
            <div class="row">
                <h2> Top message senders </h2>
                <div id="top_message_senders"></div>
            </div>
            <div class="row">
                <h2> Daywise messages </h2>
                <div id="daywise_messages"></div>
            </div>
            </div>
        </div>
    </body>
<script src={{ url_for('static', filename='js/jquery-3.4.1.min.js') }} ></script>
<script src={{ url_for('static', filename='js/bootstrap.bundle.min.js') }} ></script>
<script src={{ url_for('static', filename='js/d3.min.js') }} ></script>
<!--<script src={{ url_for('static', filename='js/analysis.js') }} ></script>-->
<script>
// Top messsage sensers graph
var margin = {"left": 150, "right": 70, "top":30, "bottom":20};
var graphHeight = 300;
var graphWidth = 700
var paddingGraphButtons = 20;
var buttonsHeight = 35;
var h = margin.top+graphHeight+paddingGraphButtons+buttonsHeight+margin.bottom;
var w = margin.left + graphWidth+ margin.right;
var buttonsPaddingRight = 350;
var buttonsPaddingInner = 0.1;

var svg = d3.select("#top_message_senders")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

var top_message_senders = {{ top_message_senders|safe }};

var yScale = d3.scaleBand()
                .domain(top_message_senders.map(x => x[0]))
                .range([margin.top, margin.top+graphHeight]);

var xScale = d3.scaleLinear()
                    .domain([0, d3.max(top_message_senders, function(d) { return d[1] })]).nice()
                    .range([0, graphWidth]);

var colorScale = d3.scaleLinear()
                    .domain([0, d3.max(top_message_senders, function(d) { return d[1] })])
                    .range([0, 1]);

var graph = svg.append("g").attr("class","top_message_senders")

graph.selectAll("rect")
        .data(top_message_senders)
        .enter()
        .append("rect")
        .attr("width", function(d) { return xScale(d[1]) })
        .attr("height", function(d) { return yScale.bandwidth() })
        .attr("x", function(d) { return margin.left+xScale(0) })
        .attr("y", function(d) { return yScale(d[0])})
        .attr("fill", function (d) { return d3.interpolateReds(colorScale(d[1]))})

var xAxis = d3.axisTop()
                .scale(xScale);
var yAxis = d3.axisLeft()
                .scale(yScale);

svg.append("g")
    .attr("id", "x-axis")
    .classed("axis", true)
    .attr("transform", "translate("+margin.left+","+margin.top+")")
    .call(xAxis);

svg.append("g")
    .attr("id", "y-axis")
    .classed("axis", true)
    .attr("transform", "translate("+margin.left+","+0+")")
    .call(yAxis);
                    
</script>
<script>
// Daywise messages graph
var margin = {"left": 150, "right": 70, "top": 10, "bottom":50};
var graphHeight = 300;
var graphWidth = 700;
var h = margin.top + graphHeight + margin.bottom;
var w = margin.left + graphWidth+ margin.right;
var buttonsPaddingRight = 350;
var buttonsPaddingInner = 0.1;

var svg = d3.select("#daywise_messages")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

clipId = "graphClipper"

svg.append("clipPath")
      .attr("id", clipId)
    .append("rect")
      .attr("x", margin.left)
      .attr("y", 0)
      .attr("width", graphWidth)
      .attr("height", h);


var daywise_messages = {{ daywise_message_count|safe }};

function parseDate(x){
    d = new Date(x);
        

}

daywise_messages = daywise_messages.map(x => [d3.timeFormat("%b %d' %y")(new Date(x[0])), x[1]])

var xScale = d3.scaleBand()
    //.domain([daywise_messages[0], daywise_messages[daywise_messages.length -1]].map(x => new Date(x[0])))
    .domain(daywise_messages.map(x => x[0]))
    //.domain([daywise_messages].map(x => new Date(x[0])))
    .range([margin.left, margin.left+ graphWidth]);

var yScale = d3.scaleLinear()
    .domain([0, d3.max(daywise_messages, function(d) { return d[1] })])
    .range([margin.top+graphHeight,margin.top]);

var colorScale = d3.scaleLinear()
                    .domain([0, d3.max(daywise_messages, function(d) { return d[1] })])
                    .range([0, 1]);

var graph = svg.append("g");
barWidth = ((xScale.range()[1]-xScale.range()[0])/daywise_messages.length)*3/4;

graph.selectAll("rect")
        .data(daywise_messages)
        .enter()
        .append("rect")
        .attr("clip-path", "url(#"+clipId+")")
        .attr("width", function(d) { return xScale.bandwidth() })
        .attr("height", function(d) { return yScale(0)-yScale(d[1])})
        .attr("x", function(d) { return xScale(d[0]) })
        .attr("y", function(d) { return yScale(d[1])})
        .attr("fill", function (d) { return d3.interpolateReds(colorScale(d[1]))})

var xAxis = d3.axisBottom()
                .scale(xScale);
//                .tickValues(xScale.domain().filter(function(d,i){ 
//                    return !(i%parseInt(20*graphWidth/(xScale.range()[1]-xScale.range()[0])))
//                }));

var yAxis = d3.axisLeft()
                .scale(yScale);

svg.append("g")
    .attr("id", "x-axis")
    .attr("clip-path", "url(#"+clipId+")")
    .classed("axis", true)
    .attr("transform", "translate("+0+","+ (margin.top+graphHeight) + ")")
    .call(xAxis);

svg.append("g")
    .attr("id", "y-axis")
    .classed("axis", true)
    .attr("transform", "translate("+margin.left+","+0+")")
    .call(yAxis);

d3.selectAll("#x-axis .tick")
    .attr("opacity", function(d,i){
        everyX = parseInt(20*graphWidth/(xScale.range()[1]-xScale.range()[0]));
        if (i%everyX)
            return 0;
        else 
            return 1;
    })

function zoomed() {
    var transform = d3.event.transform;

    oldRange = xScale.range();
    xScale.range([margin.left, w - margin.right].map(d => transform.applyX(d)));

    var newBarWidth = transform.k*barWidth;

    graph.selectAll("rect")
        .attr("width", function(d) { return xScale.bandwidth(); })
        .attr("x", function(d) { return xScale(d[0]) })

    d3.select("#daywise_messages #x-axis").call(xAxis);

    d3.selectAll("#x-axis .tick")
        .attr("opacity", function(d,i){
            everyX = parseInt(20*graphWidth/(oldRange[1]-oldRange[0]));
            if (i%everyX)
                return 0;
            else 
                return 1;
        })
        .transition()
        .attr("opacity", function(d,i){
            everyX = parseInt(20*graphWidth/(xScale.range()[1]-xScale.range()[0]));
            if (i%everyX)
                return 0;
            else 
                return 1;
        })
    }
const extent = [[margin.left, margin.top], [w- margin.right, h- margin.top]];

var zoom = d3.zoom()
    .scaleExtent([1, Infinity])
    .translateExtent(extent)
    .extent(extent)
    .on('zoom', zoomed)
svg.call(zoom);
                    
</script>
</html>


